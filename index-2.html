<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador Jurídico com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { border-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .tab-inactive { border-color: transparent; }
        .file-drop-zone { border: 2px dashed #d1d5db; }
        .file-drop-zone.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        .history-item-edit-mode { cursor: default !important; background-color: #eff6ff !important; }
        #validation-modal { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container">
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <header class="text-center mb-8">
                 <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Analisador Jurídico com IA</h1>
                <p class="text-md text-gray-600 mt-2">Analise documentos individualmente ou em lote.</p>
            </header>

            <div class="mb-6 border-b border-gray-200">
                <nav class="flex flex-wrap space-x-2 sm:space-x-4" aria-label="Tabs">
                    <button id="tab-analyzer" class="tab-active py-3 px-4 text-center text-sm sm:text-lg border-b-2 transition-colors">
                        <i class="fa-solid fa-magnifying-glass mr-2"></i>Análise Individual
                    </button>
                    <button id="tab-batch" class="tab-inactive py-3 px-4 text-center text-sm sm:text-lg text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fa-solid fa-layer-group mr-2"></i>Análise em Lote
                    </button>
                    <button id="tab-database" class="tab-inactive py-3 px-4 text-center text-sm sm:text-lg text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fa-solid fa-database mr-2"></i>Banco de Dados
                    </button>
                </nav>
            </div>

            <main>
                 <div id="panel-analyzer">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                            <div id="file-drop-zone" class="file-drop-zone rounded-lg p-8 text-center cursor-pointer hover:bg-gray-50 transition">
                                 <i class="fa-solid fa-file-arrow-up text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600 font-semibold">Arraste um arquivo (.pdf, .docx) aqui</p>
                                <p class="text-sm text-gray-500 mt-1">ou</p>
                                <input type="file" id="file-input" class="hidden" accept=".pdf,.docx,.txt">
                                <button onclick="document.getElementById('file-input').click()" class="mt-2 bg-white text-blue-600 font-semibold py-2 px-4 border border-blue-600 rounded-lg hover:bg-blue-50 transition">Selecione o Arquivo</button>
                                <div id="file-name-container" class="mt-4 text-sm text-gray-700 font-medium"></div>
                            </div>
                            <div class="my-4 text-center text-gray-500">OU</div>
                            <div>
                                <label for="document-text" class="block text-lg font-semibold mb-2 text-gray-700">Cole o Texto do Documento:</label>
                                <textarea id="document-text" rows="10" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" placeholder="Cole o texto ou o conteúdo do arquivo aparecerá aqui..."></textarea>
                            </div>
                            <div class="mt-6">
                                <label for="new-criterion-input" class="block text-lg font-semibold mb-2 text-gray-700">O que você quer encontrar?</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="new-criterion-input" class="flex-grow mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Digite um critério e clique em Adicionar">
                                    <button id="add-criterion-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all duration-300">Adicionar</button>
                                </div>
                                <div id="criteria-list-container" class="mt-4 flex flex-wrap gap-2"></div>
                            </div>
                            <div class="mt-6">
                                <h3 class="text-lg font-semibold mb-2 text-gray-700">Incluir do Banco de Dados</h3>
                                <div id="database-include-list" class="max-h-32 overflow-y-auto space-y-2 p-3 bg-gray-50 rounded-md border">
                                    <p class="text-gray-500">Nenhuma fonte no banco de dados.</p>
                                </div>
                            </div>
                            <div class="text-center mt-6">
                                <button id="analyze-button" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    <span id="analyze-button-text">Analisar e Salvar Modelo</span>
                                    <div id="analyze-loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-2 hidden"></div>
                                </button>
                            </div>
                        </div>
                        <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                            <div class="flex justify-between items-center border-b pb-2 mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Modelos</h2>
                                <button id="edit-models-button" class="text-gray-500 hover:text-blue-600 transition-colors" title="Renomear modelos">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                            </div>
                            <div id="history-list" class="space-y-3 overflow-y-auto max-h-[600px] pr-2">
                               <p id="history-loading" class="text-gray-500">Carregando modelos...</p>
                            </div>
                        </div>
                    </div>
                    <div id="results-area" class="mt-8 bg-white p-6 rounded-2xl shadow-lg hidden"></div>
                </div>

                <div id="panel-batch" class="hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Lotes de Análise Salvos</h2>
                                <div id="saved-batches-list" class="space-y-3">
                                    <p id="saved-batches-loading" class="text-gray-500">Carregando lotes salvos...</p>
                                </div>
                                 <div id="batch-progress-container" class="mt-6 hidden">
                                    <p id="batch-progress-status" class="text-center font-semibold text-gray-700 mb-2"></p>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div id="batch-progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                                    </div>
                                    <div class="text-center mt-4">
                                        <button id="batch-download-button" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 hidden">
                                            <i class="fa-solid fa-file-excel mr-2"></i>Baixar Planilha (Excel)
                                        </button>
                                    </div>
                                </div>
                            </div>
    
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Criar Novo Lote</h2>
                                <div id="batch-file-drop-zone" class="file-drop-zone rounded-lg p-8 text-center cursor-pointer hover:bg-gray-50 transition">
                                    <i class="fa-solid fa-folder-open text-4xl text-gray-400 mb-4"></i>
                                    <p class="text-gray-600 font-semibold">Arraste múltiplos arquivos (.pdf, .docx) aqui</p>
                                        <p class="text-sm text-gray-500 mt-1">ou</p>
                                    <input type="file" id="batch-file-input" class="hidden" accept=".pdf,.docx,.txt" multiple>
                                    <button onclick="document.getElementById('batch-file-input').click()" class="mt-2 bg-white text-blue-600 font-semibold py-2 px-4 border border-blue-600 rounded-lg hover:bg-blue-50 transition">Selecione os Arquivos</button>
                                </div>
                                <div id="batch-file-list" class="mt-4 max-h-40 overflow-y-auto"></div>
                                <div class="mt-6">
                                    <label class="block text-lg font-semibold mb-2 text-gray-700">Critérios para o Lote</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="batch-new-criterion-input" class="flex-grow mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Digite um critério para todos os documentos">
                                        <button id="batch-add-criterion-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all">Adicionar</button>
                                    </div>
                                    <div id="batch-criteria-list-container" class="mt-4 flex flex-wrap gap-2"></div>
                                </div>
                                <div class="mt-6">
                                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Incluir do Banco de Dados (para o lote)</h3>
                                    <div id="batch-database-include-list" class="max-h-32 overflow-y-auto space-y-2 p-3 bg-gray-50 rounded-md border">
                                        <p class="text-gray-500">Nenhuma fonte no banco de dados.</p>
                                    </div>
                                </div>
                                <div class="text-center mt-8">
                                    <button id="save-batch-button" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-purple-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        Salvar Novo Lote
                                    </button>
                                </div>
                            </div>
                        </div>
                         <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Carregar Modelo de Critérios</h2>
                            <div id="batch-history-list" class="space-y-3 overflow-y-auto max-h-[600px] pr-2">
                               <p id="batch-history-loading" class="text-gray-500">Carregando modelos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-database" class="hidden">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                            <h2 id="db-form-title" class="text-2xl font-bold text-gray-800 mb-4">Adicionar Fonte</h2>
                            <div id="db-file-drop-zone" class="file-drop-zone rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50 transition mb-4">
                                <i class="fa-solid fa-file-arrow-up text-3xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600 font-semibold text-sm">Arraste um arquivo</p>
                                <p class="text-xs text-gray-500 mt-1">ou</p>
                                <input type="file" id="db-file-input" class="hidden" accept=".pdf,.docx,.txt">
                                <button onclick="document.getElementById('db-file-input').click()" class="mt-2 bg-white text-blue-600 font-semibold py-1 px-3 text-sm border border-blue-600 rounded-lg hover:bg-blue-50 transition">Selecione</button>
                                <div id="db-file-name-container" class="mt-3 text-xs text-gray-700 font-medium"></div>
                            </div>
                            <div class="my-4 text-center text-gray-500">E/OU PREENCHA MANUALMENTE</div>
                            <div class="space-y-4">
                                <div>
                                    <label for="db-source-title" class="block text-sm font-medium text-gray-700">Título</label>
                                    <input type="text" id="db-source-title" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Lei nº 8.112/90">
                                </div>
                                <div>
                                    <label for="db-source-content" class="block text-sm font-medium text-gray-700">Conteúdo</label>
                                    <textarea id="db-source-content" rows="10" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Cole o texto completo da lei, artigo, etc."></textarea>
                                </div>
                                <input type="hidden" id="db-source-id">
                                <div class="flex space-x-2">
                                    <button id="db-save-button" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Salvar Fonte</button>
                                    <button id="db-cancel-button" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition hidden">Cancelar</button>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Fontes Salvas</h2>
                            <div id="db-list-container" class="space-y-3 overflow-y-auto max-h-[600px] pr-2">
                                <p class="text-gray-500">Carregando fontes...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
        
    <div id="validation-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative z-10">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Validação do Primeiro Documento</h2>
            <p class="mb-4 text-gray-600">Por favor, verifique se os dados extraídos do primeiro arquivo (<strong id="validation-doc-name"></strong>) estão corretos. Se estiverem, aprove para continuar com os demais documentos.</p>
            <div id="validation-results-container" class="space-y-4 border-t border-b py-4"></div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="validation-cancel-button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Cancelar Análise</button>
                <button id="validation-approve-button" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Aprovar e Continuar</button>
            </div>
        </div>
    </div>

    <div id="error-message" class="hidden fixed top-5 right-5 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50 shadow-lg" role="alert"></div>
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, updateDoc, doc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG AND INITIALIZATION ---
const GEMINI_API_KEY = "AIzaSyCdKTrAe3yBXGGgeqHvQ8wl2HGmmVWpy-k";

        const firebaseConfig = {
          apiKey: "AIzaSyDpRvlJUxvaLCX-_UuGtRIx4f-ybTZI0Y4",
          authDomain: "teste-gemini-2.firebaseapp.com",
          projectId: "teste-gemini-2",
          storageBucket: "teste-gemini-2.firebasestorage.app",
          messagingSenderId: "663768032430",
          appId: "1:663768032430:web:b07ef90a57bebf551b793f"
        };
        const appId = firebaseConfig.appId;
        let app, auth, db, userId;
        let historyUnsubscribe, dbUnsubscribe, savedBatchesUnsubscribe;
        const historyCollectionName = 'analyses';
        const dbCollectionName = 'knowledge_base';
        const batchCollectionName = 'batch_jobs';
        let isEditMode = false;
        let uploadedBatchFiles = [];
        let batchResults = [];
        let currentBatchKeyMap = {};
        let validationPromiseResolver;
        
        // --- DOM ELEMENT REFERENCES ---
        let tabs, panels, fileDropZone, fileInput, fileNameContainer, documentText, analyzeButton, analyzeLoader, resultsArea,
            historyList, historyLoading, addCriterionButton, newCriterionInput, criteriaListContainer, editModelsButton,
            databaseIncludeList, dbFormTitle, dbSourceTitle, dbSourceContent, dbSourceId, dbSaveButton, dbCancelButton,
            dbListContainer, errorMessage, toast, dbFileDropZone, dbFileInput, dbFileNameContainer,
            batchFileDropZone, batchFileInput, batchFileList, batchProgressContainer,
            batchProgressBar, batchProgressStatus, batchDownloadButton, batchNewCriterionInput,
            batchAddCriterionButton, batchCriteriaListContainer, batchHistoryList, batchHistoryLoading,
            savedBatchesList, savedBatchesLoading, saveBatchButton,
            validationModal, validationDocName, validationResultsContainer,
            validationApproveButton, validationCancelButton, batchDatabaseIncludeList;

        function initializeDomElements() {
            tabs = { analyzer: document.getElementById('tab-analyzer'), batch: document.getElementById('tab-batch'), database: document.getElementById('tab-database') };
            panels = { analyzer: document.getElementById('panel-analyzer'), batch: document.getElementById('panel-batch'), database: document.getElementById('panel-database') };
            
            // Analyzer
            fileDropZone = document.getElementById('file-drop-zone');
            fileInput = document.getElementById('file-input');
            fileNameContainer = document.getElementById('file-name-container');
            documentText = document.getElementById('document-text');
            analyzeButton = document.getElementById('analyze-button');
            analyzeLoader = document.getElementById('analyze-loader');
            resultsArea = document.getElementById('results-area');
            addCriterionButton = document.getElementById('add-criterion-button');
            newCriterionInput = document.getElementById('new-criterion-input');
            criteriaListContainer = document.getElementById('criteria-list-container');
            databaseIncludeList = document.getElementById('database-include-list');

            // Models
            historyList = document.getElementById('history-list');
            historyLoading = document.getElementById('history-loading');
            editModelsButton = document.getElementById('edit-models-button');
            
            // Batch
            batchFileDropZone = document.getElementById('batch-file-drop-zone');
            batchFileInput = document.getElementById('batch-file-input');
            batchFileList = document.getElementById('batch-file-list');
            batchProgressContainer = document.getElementById('batch-progress-container');
            batchProgressBar = document.getElementById('batch-progress-bar');
            batchProgressStatus = document.getElementById('batch-progress-status');
            batchDownloadButton = document.getElementById('batch-download-button');
            batchNewCriterionInput = document.getElementById('batch-new-criterion-input');
            batchAddCriterionButton = document.getElementById('batch-add-criterion-button');
            batchCriteriaListContainer = document.getElementById('batch-criteria-list-container');
            savedBatchesList = document.getElementById('saved-batches-list');
            savedBatchesLoading = document.getElementById('saved-batches-loading');
            saveBatchButton = document.getElementById('save-batch-button');
            batchHistoryList = document.getElementById('batch-history-list');
            batchHistoryLoading = document.getElementById('batch-history-loading');
            batchDatabaseIncludeList = document.getElementById('batch-database-include-list');
            
            // Database
            dbFormTitle = document.getElementById('db-form-title');
            dbSourceTitle = document.getElementById('db-source-title');
            dbSourceContent = document.getElementById('db-source-content');
            dbSourceId = document.getElementById('db-source-id');
            dbSaveButton = document.getElementById('db-save-button');
            dbCancelButton = document.getElementById('db-cancel-button');
            dbListContainer = document.getElementById('db-list-container');
            dbFileDropZone = document.getElementById('db-file-drop-zone');
            dbFileInput = document.getElementById('db-file-input');
            dbFileNameContainer = document.getElementById('db-file-name-container');

            // Validation Modal
            validationModal = document.getElementById('validation-modal');
            validationDocName = document.getElementById('validation-doc-name');
            validationResultsContainer = document.getElementById('validation-results-container');
            validationApproveButton = document.getElementById('validation-approve-button');
            validationCancelButton = document.getElementById('validation-cancel-button');

            // General UI
            errorMessage = document.getElementById('error-message');
            toast = document.getElementById('toast');
        }

        // --- IDB HELPER ---
        const DB_NAME = 'juridicoAppDB';
        const BATCH_STORE_NAME = 'batchFiles';
        let dbPromise;

        function openDB() {
            if (!dbPromise) {
                dbPromise = new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, 1);
                    request.onerror = () => reject("Erro ao abrir IndexedDB.");
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = event => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(BATCH_STORE_NAME)) {
                            db.createObjectStore(BATCH_STORE_NAME, { keyPath: 'id' });
                        }
                    };
                });
            }
            return dbPromise;
        }

        async function idbGet(key) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(BATCH_STORE_NAME, 'readonly');
                const store = tx.objectStore(BATCH_STORE_NAME);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function idbPut(data) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(BATCH_STORE_NAME, 'readwrite');
                const store = tx.objectStore(BATCH_STORE_NAME);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function idbDelete(key) {
             const db = await openDB();
             return new Promise((resolve, reject) => {
                const tx = db.transaction(BATCH_STORE_NAME, 'readwrite');
                const store = tx.objectStore(BATCH_STORE_NAME);
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }


        // --- INITIAL SETUP ---
        window.onload = function() {
            initializeDomElements();
            if (!firebaseConfig.apiKey) {
                 showError("Configuração do Firebase não encontrada no código. A aplicação não pode funcionar.");
                return;
            }
            initializeAppAndAuth(firebaseConfig);
        };

        async function initializeAppAndAuth(config) {
            try {
                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        setupEventListeners();
                        loadHistory();
                        loadDatabaseSources();
                        loadSavedBatches();
                        setupTabLogic();
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) { 
                console.error("Erro Firebase:", error); 
                showError("Erro crítico ao conectar com os serviços. Verifique a configuração do Firebase.");
            }
        }
        
        function setupEventListeners() {
            // Analyzer
            analyzeButton.addEventListener('click', handleAnalysis);
            addCriterionButton.addEventListener('click', () => addCriterionFromInput('analyzer'));
            newCriterionInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); addCriterionFromInput('analyzer'); } });
            
            // Models
            editModelsButton.addEventListener('click', toggleEditMode);
            
            // Database
            dbSaveButton.addEventListener('click', handleSaveDbSource);
            dbCancelButton.addEventListener('click', resetDbForm);

            // File Handling
            setupFileDropZone(fileDropZone, (files) => processAndPopulateFile(files[0] || files, null, documentText, fileNameContainer, 'analyzer'));
            fileInput.addEventListener('change', (e) => {if (e.target.files.length) processAndPopulateFile(e.target.files[0], null, documentText, fileNameContainer, 'analyzer')});
            
            setupFileDropZone(dbFileDropZone, (files) => processAndPopulateFile(files[0] || files, dbSourceTitle, dbSourceContent, dbFileNameContainer, 'database'));
            dbFileInput.addEventListener('change', (e) => {if (e.target.files.length) processAndPopulateFile(e.target.files[0], dbSourceTitle, dbSourceContent, dbFileNameContainer, 'database')});

            // Batch Analysis Listeners
            saveBatchButton.addEventListener('click', handleSaveBatch);
            batchAddCriterionButton.addEventListener('click', () => addCriterionFromInput('batch'));
            batchNewCriterionInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); addCriterionFromInput('batch'); } });
            
            setupFileDropZone(batchFileDropZone, handleBatchFiles);
            batchFileInput.addEventListener('change', (e) => handleBatchFiles(e.target.files));
            
            validationApproveButton.addEventListener('click', () => resolveValidation(true));
            validationCancelButton.addEventListener('click', () => resolveValidation(false));
            batchDownloadButton.addEventListener('click', generateExcel);
        }

        // --- All other functions (tab logic, file handling, analysis, db, history, batch, etc.) go here...
        // ... The full code from the previous version is included below this line.
        
        // --- TAB LOGIC ---
        function setupTabLogic() {
            Object.keys(tabs).forEach(key => {
                tabs[key].addEventListener('click', () => switchTab(key));
            });
        }

        function switchTab(activeKey) {
            Object.keys(panels).forEach(key => {
                panels[key].classList.toggle('hidden', key !== activeKey);
                tabs[key].classList.toggle('tab-active', key === activeKey);
                tabs[key].classList.toggle('tab-inactive', key !== activeKey);
            });
        }

        // --- GENERIC FILE HANDLING ---
        function setupFileDropZone(dropZone, callback) {
            if (!dropZone) return;
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, preventDefaults, false));
            ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('dragover'), false));
            ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('dragover'), false));
            dropZone.addEventListener('drop', (e) => { if (e.dataTransfer.files.length > 0) callback(e.dataTransfer.files); }, false);
        }
        function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }

        async function processAndPopulateFile(file, titleInput, contentTextarea, fileNameContainer, type) {
            fileNameContainer.innerHTML = `<span>Carregando: ${file.name}</span>`;
            contentTextarea.value = "Extraindo texto...";
            
            try {
                const text = await getFileText(file);
                contentTextarea.value = text;
                fileNameContainer.innerHTML = `<div class="flex items-center justify-center"><span>Arquivo: ${file.name}</span><button class="ml-2 text-red-500 hover:text-red-700" id="${type}-clear-file-btn"><i class="fa-solid fa-trash-can"></i></button></div>`;
                
                document.getElementById(`${type}-clear-file-btn`).addEventListener('click', () => {
                     contentTextarea.value = '';
                     fileNameContainer.innerHTML = '';
                     if(titleInput) titleInput.value = '';
                     if(type === 'analyzer') fileInput.value = '';
                     if(type === 'database') dbFileInput.value = '';
                });

                if (titleInput) {
                    titleInput.value = file.name.replace(/\.[^/.]+$/, "");
                }
            } catch (err) {
                showError(`Erro ao processar arquivo: ${err.message}`);
                contentTextarea.value = '';
                fileNameContainer.innerHTML = '';
                if (titleInput) titleInput.value = '';
            }
        }
        
        async function getFileText(file) {
            if (file.type === 'application/pdf') return await extractTextFromPdf(file);
            if (file.type.includes('wordprocessingml')) return await extractTextFromDocx(file);
            if (file.type === 'text/plain') return await file.text();
            throw new Error(`Formato de arquivo não suportado: ${file.type}`);
        }

        async function extractTextFromPdf(file) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
            const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }
            return fullText;
        }
        async function extractTextFromDocx(file) {
            const { value } = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
            return value;
        }

        // --- CRITERIA MANAGEMENT ---
        function addCriterionFromInput(type = 'analyzer'){
            const inputEl = type === 'batch' ? batchNewCriterionInput : newCriterionInput;
            const text = inputEl.value.trim();
            if (text) {
                createCriterionTag(text, type);
                inputEl.value = '';
                inputEl.focus();
            }
        }
        function createCriterionTag(text, type = 'analyzer') {
            const container = type === 'batch' ? batchCriteriaListContainer : criteriaListContainer;
            const tagEl = document.createElement('div');
            tagEl.className = 'criterion-tag flex items-center bg-blue-100 text-blue-800 text-sm font-medium pl-3 pr-2 py-1 rounded-full';
            tagEl.dataset.criterion = text;
            tagEl.innerHTML = `<span>${text}</span><button class="ml-2 text-blue-500 hover:text-blue-700 focus:outline-none"><i class="fa-solid fa-times-circle"></i></button>`;
            tagEl.querySelector('button').onclick = () => { tagEl.remove(); };
            container.appendChild(tagEl);
        }

        // --- ANALYSIS LOGIC ---
        async function handleAnalysis() {
            const text = documentText.value.trim();
            if (!text) { showError('Por favor, insira texto ou carregue um arquivo.'); return; }
            const { keyToTitleMap } = buildDynamicSchema('analyzer');
            if (Object.keys(keyToTitleMap).length === 0) { showError("Adicione pelo menos um critério de busca."); return; }
            
            setLoadingState(analyzeButton, analyzeLoader, true);
            resultsArea.classList.remove('hidden');
            resultsArea.innerHTML = '<p class="text-center text-gray-500">Analisando...</p>';
            
            try {
                const { schema } = buildDynamicSchema('analyzer');
                const analysis = await analyzeSingleDocument(text, schema, 'analyzer', keyToTitleMap);
                displayAnalysisResults(analysis, null, keyToTitleMap);
                let modelName = analysis[Object.keys(analysis)[0]] || "Novo Modelo";
                modelName = modelName.substring(0, 40) + (modelName.length > 40 ? '...' : '');
                await saveAnalysisToHistory(modelName, keyToTitleMap);
            } catch (error) {
                console.error("Erro na Análise:", error);
                showError(error.message || "Não foi possível concluir a análise.");
            } finally {
                setLoadingState(analyzeButton, analyzeLoader, false);
            }
        }
        
        async function getDatabaseContext(type = 'analyzer') {
            const container = type === 'batch' ? batchDatabaseIncludeList : databaseIncludeList;
            if(!container) return '';
            const selectedDbIds = Array.from(container.querySelectorAll('input:checked')).map(input => input.value);
            if (selectedDbIds.length === 0) return '';
            let context = 'Use o seguinte contexto do seu banco de dados para auxiliar na análise:\n';
            for (const id of selectedDbIds) {
                const docRef = doc(db, "artifacts", appId, "users", userId, dbCollectionName, id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    context += `\n--- CONTEXTO: ${data.title} ---\n${data.content}\n--- FIM DO CONTEXTO ---\n`;
                }
            }
            return context;
        }

        function buildDynamicSchema(type = 'analyzer') {
            const container = type === 'batch' ? batchCriteriaListContainer : criteriaListContainer;
            const criteriaForPrompt = [];
            const schemaProperties = {};
            const keyToTitleMap = {};
            const criteriaTags = container.querySelectorAll('.criterion-tag');
            criteriaTags.forEach(tag => {
                const cleanCriterion = tag.dataset.criterion;
                const key = 'key_' + cleanCriterion.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, '').replace(/\s+/g, '_').toLowerCase().substring(0, 40);
                criteriaForPrompt.push(`- ${cleanCriterion}: Extraia a informação sobre '${cleanCriterion}'.`);
                schemaProperties[key] = { type: 'STRING', description: `Conteúdo extraído para: ${cleanCriterion}` };
                keyToTitleMap[key] = cleanCriterion;
            });
            const schema = { type: "OBJECT", properties: schemaProperties };
            return { criteria: criteriaForPrompt, schema, keyToTitleMap };
        }
        function displayAnalysisResults(data, historyItemId, keyToTitleMap) {
            const titleKey = Object.keys(data)[0] || null;
            const titleText = titleKey && data[titleKey] ? (data[titleKey].substring(0, 50) + '...') : 'Análise Concluída';
            resultsArea.classList.remove('hidden');
            resultsArea.innerHTML = `<div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">${titleText}</h2>${historyItemId ? `<button onclick="window.deleteHistoryItem('${historyItemId}')" class="text-red-500 hover:text-red-700" title="Apagar Modelo"><i class="fa-solid fa-trash-can"></i></button>` : ''}</div><div id="dynamic-results-container" class="space-y-6 mt-6"></div>`;
            const container = resultsArea.querySelector('#dynamic-results-container');
            container.innerHTML = '';
            for (const key in keyToTitleMap) {
                const value = data[key] || "Informação não encontrada.";
                const formattedTitle = keyToTitleMap[key];
                const cardId = `result-${key}-${Date.now()}`;
                container.innerHTML += createResultCard(cardId, formattedTitle, value);
            }
            resultsArea.scrollIntoView({ behavior: 'smooth' });
        }
        function createResultCard(id, title, content) {
            return `<div class="bg-gray-50 p-4 rounded-lg shadow-sm"><div class="flex justify-between items-center mb-2"><h3 class="text-xl font-semibold text-gray-700">${title}</h3><button onclick="copyToClipboard('${id}')" class="bg-gray-200 text-gray-600 hover:bg-gray-300 text-sm py-1 px-3 rounded-md">Copiar</button></div><div id="${id}" class="text-gray-600 whitespace-pre-wrap"><p>${content}</p></div></div>`;
        }

        // --- DATABASE PANEL LOGIC ---
        function loadDatabaseSources() {
            if (!db || !userId) return;
            const dbCollectionRef = collection(db, "artifacts", appId, "users", userId, dbCollectionName);
            if (dbUnsubscribe) dbUnsubscribe();
            dbUnsubscribe = onSnapshot(dbCollectionRef, (snapshot) => {
                dbListContainer.innerHTML = '';
                databaseIncludeList.innerHTML = ''; 
                if (batchDatabaseIncludeList) batchDatabaseIncludeList.innerHTML = '';
                if (snapshot.empty) {
                    const msg = '<p class="text-gray-500">Nenhuma fonte salva.</p>';
                    dbListContainer.innerHTML = msg;
                    databaseIncludeList.innerHTML = msg;
                    if (batchDatabaseIncludeList) batchDatabaseIncludeList.innerHTML = msg;
                } else {
                    const sources = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    sources.forEach(source => {
                        const el = document.createElement('div');
                        el.className = 'p-4 bg-gray-50 rounded-lg border flex justify-between items-start';
                        el.innerHTML = `<div><h4 class="font-semibold text-gray-800">${source.title}</h4><p class="text-sm text-gray-500 mt-1 truncate">${source.content.substring(0, 100)}...</p></div><div class="flex space-x-2 flex-shrink-0 ml-4"><button class="db-edit-btn text-gray-400 hover:text-blue-600" data-id="${source.id}"><i class="fa-solid fa-pencil"></i></button><button class="db-delete-btn text-gray-400 hover:text-red-600" data-id="${source.id}"><i class="fa-solid fa-trash-can"></i></button></div>`;
                        dbListContainer.appendChild(el);
                        const cbHtml = `<div class="flex items-center"><input id="db-cb-${source.id}" value="${source.id}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="db-cb-${source.id}" class="ml-2 text-gray-700">${source.title}</label></div>`;
                        databaseIncludeList.innerHTML += cbHtml;
                        if (batchDatabaseIncludeList) batchDatabaseIncludeList.innerHTML += cbHtml.replace(`id="db-cb-`,`id="batch-db-cb-`).replace(`for="db-cb-`,`for="batch-db-cb-`);
                    });
                    dbListContainer.querySelectorAll('.db-edit-btn').forEach(btn => btn.addEventListener('click', () => handleEditDbSource(btn.dataset.id)));
                    dbListContainer.querySelectorAll('.db-delete-btn').forEach(btn => btn.addEventListener('click', () => handleDeleteDbSource(btn.dataset.id)));
                }
            });
        }

        async function handleSaveDbSource() {
            const title = dbSourceTitle.value.trim();
            const content = dbSourceContent.value.trim();
            const id = dbSourceId.value;
            if (!title || !content) { showError("Título e conteúdo são obrigatórios."); return; }
            try {
                if (id) {
                    await updateDoc(doc(db, "artifacts", appId, "users", userId, dbCollectionName, id), { title, content });
                    showToast("Fonte atualizada!", "success");
                } else {
                    await addDoc(collection(db, "artifacts", appId, "users", userId, dbCollectionName), { title, content, createdAt: new Date() });
                    showToast("Fonte salva!", "success");
                }
                resetDbForm();
            } catch (error) { console.error("Erro ao salvar fonte:", error); showError("Não foi possível salvar a fonte de dados."); }
        }
        
        async function handleEditDbSource(id) {
            const docRef = doc(db, "artifacts", appId, "users", userId, dbCollectionName, id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                dbFormTitle.textContent = "Editar Fonte";
                dbSourceId.value = id;
                dbSourceTitle.value = data.title;
                dbSourceContent.value = data.content;
                dbCancelButton.classList.remove('hidden');
            }
        }
        
        async function handleDeleteDbSource(id) {
            if (!confirm("Tem certeza que deseja apagar esta fonte de dados?")) return;
            try { await deleteDoc(doc(db, "artifacts", appId, "users", userId, dbCollectionName, id)); showToast("Fonte apagada.", "success"); } 
            catch (error) { showError("Erro ao apagar fonte."); }
        }

        function resetDbForm() {
            dbFormTitle.textContent = "Adicionar Fonte";
            dbSourceId.value = '';
            dbSourceTitle.value = '';
            dbSourceContent.value = '';
            dbFileNameContainer.innerHTML = '';
            dbFileInput.value = '';
            dbCancelButton.classList.add('hidden');
        }

        // --- HISTORY/MODELS LOGIC ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const icon = editModelsButton.querySelector('i');
            icon.classList.toggle('fa-pencil', !isEditMode);
            icon.classList.toggle('fa-check', isEditMode);
            editModelsButton.classList.toggle('text-blue-600', isEditMode);
            loadHistory();
        }

        function loadHistory() {
            if (!db || !userId) return;
            const historyRef = collection(db, "artifacts", appId, "users", userId, historyCollectionName);
            if (historyUnsubscribe) historyUnsubscribe();
            historyUnsubscribe = onSnapshot(historyRef, (snapshot) => {
                historyLoading.classList.add('hidden');
                batchHistoryLoading.classList.add('hidden');
                historyList.innerHTML = '';
                batchHistoryList.innerHTML = '';

                if (snapshot.empty) {
                    const msg = '<p class="text-gray-500 text-sm">Nenhum modelo salvo.</p>';
                    historyList.innerHTML = msg;
                    batchHistoryList.innerHTML = msg;
                    return;
                }
                const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'history-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 border';
                    el.dataset.itemId = item.id;
                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'font-semibold truncate';
                    titleSpan.textContent = item.title;
                    el.appendChild(titleSpan);

                    const batchEl = el.cloneNode(true);

                    if (isEditMode) {
                        el.classList.add('history-item-edit-mode');
                        titleSpan.onclick = () => makeItemEditable(el, item.id, item.title);
                    } else {
                         el.onclick = () => viewHistoryItem(item.id, 'analyzer');
                    }
                    
                    batchEl.onclick = () => viewHistoryItem(item.id, 'batch');
                    batchHistoryList.appendChild(batchEl);
                    historyList.appendChild(el);
                });
            });
        }
        
        function makeItemEditable(element, itemId, currentTitle) {
            element.onclick = null;
            element.innerHTML = '';
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'w-full p-1 border rounded-md';
            input.onblur = () => loadHistory();
            input.onkeydown = async (e) => {
                if (e.key === 'Enter') { e.preventDefault(); await renameModel(itemId, input.value); input.blur(); }
                else if (e.key === 'Escape') { input.blur(); }
            };
            element.appendChild(input);
            input.focus();
            input.select();
        }
        
        async function renameModel(itemId, newTitle) {
            if (!newTitle.trim()) { showError("O nome do modelo não pode ser vazio."); return; }
            try { await updateDoc(doc(db, "artifacts", appId, "users", userId, historyCollectionName, itemId), { title: newTitle }); showToast("Modelo renomeado!", "success"); }
            catch(error) { console.error("Erro ao renomear:", error); showError("Falha ao renomear."); }
        }
        
        async function viewHistoryItem(itemId, type) {
            if (isEditMode && type === 'analyzer') return;
            const docRef = doc(db, "artifacts", appId, "users", userId, historyCollectionName, itemId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const savedData = docSnap.data();
                    const container = type === 'batch' ? batchCriteriaListContainer : criteriaListContainer;
                    container.innerHTML = '';
                    if (savedData.keyMap) { Object.values(savedData.keyMap).forEach(criterionText => createCriterionTag(criterionText, type)); }
                    switchTab(type);
                    showToast("Modelo carregado.", "success");
                } 
                else { showError("Modelo não encontrado."); }
            } catch (error) { showError("Erro ao buscar modelo."); }
        }
        
        window.deleteHistoryItem = async function(itemId) {
            if (!confirm("Tem certeza que deseja apagar este modelo?")) return;
            try {
                await deleteDoc(doc(db, "artifacts", appId, "users", userId, historyCollectionName, itemId));
                resultsArea.classList.add('hidden');
                showToast("Modelo apagado.", "success");
                if (isEditMode) toggleEditMode();
            } catch (error) { showError("Erro ao apagar modelo."); }
        };

        async function saveAnalysisToHistory(title, keyToTitleMap) {
            if (!db || !userId) return;
            try { await addDoc(collection(db, "artifacts", appId, "users", userId, historyCollectionName), { title, keyMap: keyToTitleMap, timestamp: new Date() }); }
            catch (error) { console.error("Erro ao salvar:", error); showError("Não foi possível salvar como modelo."); }
        }
        
        // --- BATCH ANALYSIS LOGIC ---
        function handleBatchFiles(files) {
            uploadedBatchFiles = Array.from(files);
            renderBatchFileList();
        }

        function renderBatchFileList() {
            batchFileList.innerHTML = '';
            if(uploadedBatchFiles.length === 0) return;
            const list = document.createElement('ul');
            list.className = 'list-disc pl-5 text-sm text-gray-600 space-y-1';
            uploadedBatchFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center';
                li.innerHTML = `<span>${file.name}</span><button data-index="${index}" class="batch-delete-file-btn text-red-500 hover:text-red-700"><i class="fa-solid fa-trash-can"></i></button>`;
                list.appendChild(li);
            });
            batchFileList.appendChild(list);
            batchFileList.querySelectorAll('.batch-delete-file-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
                    uploadedBatchFiles.splice(indexToRemove, 1);
                    renderBatchFileList();
                });
            });
        }

        async function handleSaveBatch() {
            if (uploadedBatchFiles.length === 0) {
                showError("Carregue ao menos um arquivo para o lote.");
                return;
            }
            const { keyToTitleMap } = buildDynamicSchema('batch');
            if (Object.keys(keyToTitleMap).length === 0) {
                showError("Adicione ao menos um critério para o lote.");
                return;
            }

            const batchName = prompt("Digite um nome para este lote:", `Lote de ${uploadedBatchFiles.length} arquivos`);
            if (!batchName) return;

            try {
                const batchMetaDocRef = await addDoc(collection(db, "artifacts", appId, "users", userId, batchCollectionName), {
                    name: batchName,
                    fileCount: uploadedBatchFiles.length,
                    keyMap: keyToTitleMap,
                    status: 'Pendente',
                    createdAt: new Date()
                });

                await idbPut({
                    id: batchMetaDocRef.id,
                    name: batchName,
                    files: uploadedBatchFiles,
                    keyMap: keyToTitleMap
                });
                
                showToast("Lote salvo com sucesso!", "success");
                uploadedBatchFiles = [];
                batchFileList.innerHTML = '';
                batchCriteriaListContainer.innerHTML = '';

            } catch (error) {
                console.error("Erro ao salvar lote:", error);
                showError("Falha ao salvar o lote. Verifique o console para mais detalhes.");
            }
        }
        
        function loadSavedBatches() {
            if (!db || !userId) return;
            const batchesRef = collection(db, "artifacts", appId, "users", userId, batchCollectionName);
            if(savedBatchesUnsubscribe) savedBatchesUnsubscribe();
            savedBatchesUnsubscribe = onSnapshot(batchesRef, (snapshot) => {
                savedBatchesLoading.classList.add('hidden');
                savedBatchesList.innerHTML = '';
                if(snapshot.empty) {
                    savedBatchesList.innerHTML = '<p class="text-gray-500 text-sm">Nenhum lote salvo.</p>';
                    return;
                }
                const batches = snapshot.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                batches.forEach(batch => {
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-gray-50 rounded-lg border flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${batch.name}</p>
                            <p class="text-xs text-gray-500">${batch.fileCount} arquivos | Criado em: ${new Date(batch.createdAt.toDate()).toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button data-id="${batch.id}" class="start-batch-btn bg-blue-500 text-white w-8 h-8 rounded-full hover:bg-blue-600 flex items-center justify-center" title="Iniciar Análise"><i class="fa-solid fa-play"></i></button>
                            <button data-id="${batch.id}" class="delete-batch-btn text-red-500 hover:text-red-700" title="Excluir Lote"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                    savedBatchesList.appendChild(el);
                });

                savedBatchesList.querySelectorAll('.start-batch-btn').forEach(btn => btn.addEventListener('click', (e) => startAnalysisOfSavedBatch(e.currentTarget.dataset.id)));
                savedBatchesList.querySelectorAll('.delete-batch-btn').forEach(btn => btn.addEventListener('click', (e) => deleteSavedBatch(e.currentTarget.dataset.id)));
            });
        }
        
        async function deleteSavedBatch(batchId) {
            if(!confirm("Tem certeza que deseja excluir este lote? A ação não pode ser desfeita.")) return;
            try {
                await deleteDoc(doc(db, "artifacts", appId, "users", userId, batchCollectionName, batchId));
                await idbDelete(batchId);
                showToast("Lote excluído.", "success");
            } catch (error) {
                console.error("Erro ao excluir lote:", error);
                showError("Não foi possível excluir o lote.");
            }
        }
        
        async function startAnalysisOfSavedBatch(batchId) {
            try {
                const batchData = await idbGet(batchId);
                if(!batchData) {
                    showError("Dados do lote não encontrados no armazenamento local. Tente salvar novamente.");
                    return;
                }
                
                uploadedBatchFiles = batchData.files; 
                const { keyToTitleMap, schema } = buildDynamicSchemaFromMap(batchData.keyMap);
                
                currentBatchKeyMap = keyToTitleMap;

                await handleBatchAnalysisFlow(keyToTitleMap, schema);

            } catch(error) {
                console.error("Erro ao iniciar análise do lote:", error);
                showError("Não foi possível carregar o lote para análise.");
            }
        }
        
        function buildDynamicSchemaFromMap(keyMap) {
            const criteriaForPrompt = [];
            const schemaProperties = {};
            for(const key in keyMap) {
                const cleanCriterion = keyMap[key];
                criteriaForPrompt.push(`- ${cleanCriterion}: Extraia a informação sobre '${cleanCriterion}'.`);
                schemaProperties[key] = { type: 'STRING', description: `Conteúdo extraído para: ${cleanCriterion}` };
            }
            const schema = { type: "OBJECT", properties: schemaProperties };
            return { criteria: criteriaForPrompt, schema, keyToTitleMap: keyMap };
        }


        async function handleBatchAnalysisFlow(fixedKeyMap, fixedSchema) {
            batchProgressContainer.classList.remove('hidden');
            batchDownloadButton.classList.add('hidden');
            batchResults = [];

            updateBatchProgress(0, `Validando: ${uploadedBatchFiles[0].name}`);
            try {
                const firstFileText = await getFileText(uploadedBatchFiles[0]);
                const firstResult = await analyzeSingleDocument(firstFileText, fixedSchema, 'batch', fixedKeyMap);
                const isValid = await showValidationModal(firstResult, uploadedBatchFiles[0].name, fixedKeyMap);
                
                if (!isValid) { resetBatchState("Análise cancelada."); return; }
                
                batchResults.push(firstResult);
                updateBatchProgress(1, `Analisando 2/${uploadedBatchFiles.length}: ${uploadedBatchFiles[1]?.name || ''}`);
            } catch (error) {
                resetBatchState(`Erro no 1º documento: ${error.message}`);
                return;
            }

            for (let i = 1; i < uploadedBatchFiles.length; i++) {
                const file = uploadedBatchFiles[i];
                updateBatchProgress(i + 1, `Analisando ${i + 1}/${uploadedBatchFiles.length}: ${file.name}`);
                try {
                    const fileText = await getFileText(file);
                    const result = await analyzeSingleDocument(fileText, fixedSchema, 'batch', fixedKeyMap);
                    batchResults.push(result);
                } catch (error) {
                    const failureResult = {};
                    Object.keys(fixedKeyMap).forEach(key => failureResult[key] = `FALHA: ${error.message}`);
                    batchResults.push(failureResult);
                }
            }

            updateBatchProgress(uploadedBatchFiles.length, "Análise concluída!");
            batchDownloadButton.classList.remove('hidden');
        }
        
        async function analyzeSingleDocument(text, schema, type, keyMap) {
            const dbContext = await getDatabaseContext(type);
            const criteria = Object.values(keyMap);
            const prompt = `${dbContext} Você é um assistente jurídico. Analise o texto: ###${text}###. Extraia: ${criteria.join(', ')}. Responda em JSON.`;
            return await callGeminiAPI(prompt, schema);
        }

        function updateBatchProgress(currentIndex, statusText) {
            const total = uploadedBatchFiles.length;
            const percentage = total > 0 ? (currentIndex / total) * 100 : 0;
            batchProgressBar.style.width = `${percentage}%`;
            batchProgressStatus.textContent = statusText;
        }
        
        function resetBatchState(status) {
            updateBatchProgress(0, status || "Pronto para iniciar.");
            setTimeout(() => { batchProgressContainer.classList.add('hidden'); }, 3000);
        }

        // --- VALIDATION MODAL LOGIC ---
        function showValidationModal(result, docName, keyToTitleMap) {
            validationDocName.textContent = docName;
            validationResultsContainer.innerHTML = '';
            for (const key in keyToTitleMap) {
                const title = keyToTitleMap[key];
                const value = result[key] || "Não encontrado";
                validationResultsContainer.innerHTML += createResultCard(`val-${key}`, title, value);
            }
            validationModal.classList.remove('hidden');
            validationModal.classList.add('flex');
            return new Promise(resolve => { validationPromiseResolver = resolve; });
        }

        function resolveValidation(isApproved) {
            validationModal.classList.add('hidden');
            validationModal.classList.remove('flex');
            if (validationPromiseResolver) { validationPromiseResolver(isApproved); }
        }
        
        // --- EXCEL GENERATION ---
        function generateExcel() {
            if(!currentBatchKeyMap || Object.keys(currentBatchKeyMap).length === 0){
                showError("Não foi possível determinar os cabeçalhos para a planilha. Tente novamente.");
                return;
            }
            
            const headers = ['Nome do Arquivo', ...Object.values(currentBatchKeyMap)];
            const dataForSheet = batchResults.map((result, index) => {
                const row = { 'Nome do Arquivo': uploadedBatchFiles[index].name };
                for (const key in currentBatchKeyMap) {
                    const header = currentBatchKeyMap[key];
                    row[header] = result[key] || "";
                }
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(dataForSheet, {header: headers});
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Resultados");
            XLSX.writeFile(wb, "analise_em_lote.xlsx");
        }

        // --- GEMINI API CALLER ---
        async function callGeminiAPI(prompt, schema) {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (schema) { payload.generationConfig = { responseMimeType: "application/json", responseSchema: schema }; }
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Erro na API: ${response.status}. ${await response.text()}`);
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const text = result.candidates[0].content.parts[0].text;
                return schema ? JSON.parse(text) : text;
            } else { console.error("Resposta inválida:", result); throw new Error("A resposta da API está em formato inválido."); }
        }

        // --- UTILITY FUNCTIONS ---
        function setLoadingState(button, loader, isLoading) {
            button.disabled = isLoading;
            const span = button.querySelector('span');
            if (span) span.classList.toggle('hidden', isLoading);
            if (loader) loader.classList.toggle('hidden', !isLoading);
            button.classList.toggle('flex', isLoading);
            button.classList.toggle('items-center', isLoading);
            button.classList.toggle('justify-center', isLoading);
        }
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.className = 'fixed top-5 right-5 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50 shadow-lg block';
            setTimeout(() => errorMessage.classList.add('hidden'), 5000);
        }
        function showToast(message, type = "info") {
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${type === 'success' ? 'bg-green-600' : 'bg-gray-900'}`;
            toast.classList.remove('opacity-0');
            setTimeout(() => { toast.classList.add('opacity-0'); }, 2000);
        }
        window.copyToClipboard = function(elementId, isTextarea = false) {
            const el = document.getElementById(elementId);
            const content = isTextarea ? el.value : el.innerText;
            const temp = document.createElement('textarea');
            temp.value = content;
            document.body.appendChild(temp);
            temp.select();
            try { document.execCommand('copy'); showToast("Texto copiado!"); } catch (err) { console.error('Falha ao copiar: ', err); }
            document.body.removeChild(temp);
        }
        window.viewHistoryItem = viewHistoryItem;
    </script>
</body>
</html>
